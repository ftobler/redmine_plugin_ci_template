name: Integration Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start services
        run: docker compose up -d

      # Free parallelism â€” Python installs while Redmine migrates
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install test dependencies
        run: pip install -r test/requirements.txt

      - name: Wait for Redmine to be ready
        run: |
          echo "Waiting for Redmine..."
          for i in $(seq 1 36); do
            curl -sf http://localhost/ && echo "Redmine is up!" && break
            echo "Attempt $i/36, sleeping 5s..."
            sleep 5
          done
          sleep 1

      - name: Bootstrap Redmine
        run: |
          MYSQL="docker compose exec -T db mariadb -uredmine -predmine_password redmine"

          # Allow admin login (password not expired)
          $MYSQL -e "UPDATE users SET must_change_passwd = 0 WHERE login = 'admin';"

          # Enable REST API
          $MYSQL -e "INSERT INTO settings (name, value, updated_on)
                     VALUES ('rest_api_enabled', '1', NOW())
                     ON DUPLICATE KEY UPDATE value = '1';"

          # Create a known API token for admin (user_id = 1)
          $MYSQL -e "INSERT INTO tokens (user_id, action, value, created_on, updated_on)
                     VALUES (1, 'api', 'testtoken1234', NOW(), NOW());"

      - name: Run API test
        run: pytest test/ -v -s
        env:
          REDMINE_URL: http://localhost
          REDMINE_API_KEY: testtoken1234

      - name: Dump docker logs
        run: docker compose logs